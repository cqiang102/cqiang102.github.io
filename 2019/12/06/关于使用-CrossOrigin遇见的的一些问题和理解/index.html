<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>关于使用@CrossOrigin遇见的的一些问题和理解 | 沐凉`Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9f079225bd1f448b281e063cb99fa3db";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">主页</a><a class="sidebar-nav-item" href="/archives/">归档</a><a class="sidebar-nav-item" href="/links/">友联</a><a class="sidebar-nav-item" href="/about/">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Spring/" rel="tag">Spring</a></div><div class="post-time">2019-12-06</div></div></div><div class="container post-header"><h1>关于使用@CrossOrigin遇见的的一些问题和理解</h1></div><div class="container post-content"><h3 id="记录今天遇到的一个问题"><a href="#记录今天遇到的一个问题" class="headerlink" title="记录今天遇到的一个问题"></a>记录今天遇到的一个问题</h3><blockquote>
<p>个人理解 参考需谨慎。如果有错误，谢大佬指点</p>
</blockquote>
<p>是关于跨域的，在昨天写项目的时候遇到的跨域请求的问题，网上通常的配置方法都是使用 过滤器，或者 实现 <code>WebMvcConfigurer</code> 接口的方法。相对来说有些老了。不符合我想要的效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">"/**"</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">"*"</span>)</span><br><span class="line">                .allowedMethods(<span class="string">"GET"</span>, <span class="string">"HEAD"</span>, <span class="string">"POST"</span>, <span class="string">"PUT"</span>, <span class="string">"DELETE"</span>, <span class="string">"OPTIONS"</span>)</span><br><span class="line">                .allowCredentials(<span class="keyword">true</span>)</span><br><span class="line">                .maxAge(<span class="number">3600</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">"*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我在阅读 Spring 官网 看到有使用 <code>@CrossOrigin</code> 方式可以只需要加一个注解就行(简单粗暴我喜欢)。于是我便采用的这种方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span>(value = <span class="string">"*"</span>,allowCredentials = <span class="string">"true"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">login</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"userName"</span>,user.getUserName());</span><br><span class="line">        map.put(<span class="string">"userPass"</span>,user.getUserPass());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"logout"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">logout</span><span class="params">(@RequestBody String token)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"token"</span>,token);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置之后问题就来了在访问 login 接口的时候可以正常访问，但是 请求 logout接口的时候，还是出现的跨域的问题。</p>
<p>在反复检查配置，阅读官网后。尝试了上面的方法配置，完全没问题 (那我代码应该没问题 2333),但是换回  <code>@CrossOrigin</code> 依旧请求失败。</p>
<p>由于那种配置方法比较死，不是很灵活 (我不喜欢)。所以我想继续使用 <code>@CrossOrigin</code> 的方式配置。</p>
<p>于是便把部分代码抽取出来，单独建一个干净的项目复现刚才的问题。</p>
<p>按照 Spring 官网的配置方法一路通畅。于是对比这个 demo 和我原先的 项目,便发现了原因 ！！！ </p>
<p>因为我配置了一个登录拦截器，用于验证 token 。拦截器不拦截 login 方法。拦截需要验证 token 的方法，所以就出现了部分有效，部分无效的问题。<br>所有经过了拦截器的方法都无法访问。</p>
<p>好，知道了问题的所在，让我继续翻文档。。。。</p>
<p>了解到。<code>@CrossOrigin</code>  这个注解本质也是一个拦截器,往response里添加  <code>Access-Control-Allow-Origin</code> 等响应头信息。<br>如果在 controller 类上或在方法上标了 <code>@CrossOrigin</code> 注解，则 spring 在记录 mapping 映射时会记录对应跨域请求映射。</p>
<p>当一个跨域请求过来时，spring    在获取 handler 时会判断这个请求是否是一个跨域请求，如果是，则会返回一个可以处理跨域的 handler</p>
<p>QAQ 这时候找到 <code>HandlerMapping</code> 里的 <code>getCorsHandlerExecutionChain</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getCorsHandlerExecutionChain</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">		HandlerExecutionChain chain, @Nullable CorsConfiguration config)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;</span><br><span class="line">		HandlerInterceptor[] interceptors = chain.getInterceptors();</span><br><span class="line">		chain = <span class="keyword">new</span> HandlerExecutionChain(<span class="keyword">new</span> PreFlightHandler(config), interceptors);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// 写死了 index 0 emmmm</span></span><br><span class="line">		chain.addInterceptor(<span class="number">0</span>, <span class="keyword">new</span> CorsInterceptor(config));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到 <code>CorsInterceptor</code>的 <code>preHandle</code>打上断电点，和自己的拦截器打上断点(自己的先执行，凉凉)</p>
<p>好像 Spring 也没给配置拦截器执行顺序的东东（菜鸡的我不知道）</p>
<p>到此可以知道，<code>@CrossOrigin</code> 是在 spring 映射 handler 的时候 干的活。那既然拦截器不行，那我就用 Spring AOP 吧 QWQ !!!<br>或者在拦截器中设置，只要是预请求（OPTIONS）全部直接放行</p>
</div></div><div class="post-main post-comment"><script src="//utteranc.es/client.js" repo="cqiang102/comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>